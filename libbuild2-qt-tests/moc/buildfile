# @@ TODO Test generated headers

qt.version = $config.libbuild2_qt_tests.qt

using qt.moc

if ($qt.version == 5)
  import libs = libQt5Core%lib{Qt5Core}
else
  import libs = libQt6Core%lib{Qt6Core}

# Headers, source files.
#
exe{driver}: hxx{source sink} cxx{driver sink}

# C++ source files generated by moc.
#
# cxx{*} are generated from hxx{} and are compiled (by convention).
#
# moc{*} are generated from cxx{} and are included.
#
exe{driver}: cxx{moc_source sink_moc} # Compiled.
exe{driver}: moc{sink}                # Included.

# Libraries.
#
exe{driver}: $libs

# Generate:
#
# moc_source.cxx from source.hxx
# sink_moc.cxx   from sink.hxx (note: unconventional output filename)
# sinc.moc       from sink.cxx
#
# Use a rule hint for cxx{sink_moc} because it breaks the moc naming
# conventions (which recommend a `moc_` prefix for outputs generated from
# headers).
#
# Add $libs as prerequisites to cause their exported options (macro
# definitions, header search directories, etc.) to be passed to moc.
#
cxx{moc_source}:                    hxx{source} $libs
[rule_hint=qt.moc] cxx{sink_moc}:   hxx{sink}   $libs
moc{sink}:                          cxx{sink}   $libs

# Set the include path prefix.
#
# @@ TODO Note that moc always includes with quotes if the prefix is present
#    (angle brackets not supported).
#
qt.moc.options = -p moc

cxx.poptions += "-I$out_root" "-I$src_root"
